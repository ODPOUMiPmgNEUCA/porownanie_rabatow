# -*- coding: utf-8 -*-
"""Soczyste rabaty.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bfU5lwdNa2GOPWmQ9-URaf30VnlBzQC0
"""

#importowanie potrzebnych bibliotek
import os
import openpyxl
import streamlit as st
import pandas as pd
import numpy as np
import altair as alt
import plotly.express as px
import plotly.graph_objects as go
from urllib.request import urlopen
import json
import io
import datetime



st.set_page_config(page_title='PorÃ³wnanie rabatÃ³w - IPRA vs P+', layout='wide')



tabs_font_css = """
<style>
div[class*="stTextInput"] label {
  font-size: 26px;
  color: black;
}
div[class*="stSelectbox"] label {
  font-size: 26px;
  color: black;
}
</style>
"""

st.title("Automat PORÃ“WNANIE RABATÃ“W")

st.markdown("""
### Jak korzystaÄ‡ z aplikacji? - Instrukcja obsÅ‚ugi
1. Nie przejmuj siÄ™, Å¼e strona wyÅ›wietla bÅ‚Ä…d: **TypeError**. BÄ™dzie on widoczny, dopÃ³ki nie wrzucisz pliku z Raportem promocyjnym, ktÃ³ry codziennie dostajesz na maila :)
2. Jak go wrzuciÄ‡?  
    2.1. Pobierz folder z maila.  
    2.2. Folder pobierze siÄ™ w formacie **.zip** (jak na obrazku poniÅ¼ej - zip - ten zasuwak na folderze).
""")


st.image("potrzebne_fotki/zip.png")

st.markdown("""
<div style="padding-left: 40px;">
    <p style="margin: 0;">2.3. Rozpakuj pobrany folder .zip, klikajÄ…c na niego prawym przyciskiem myszy i wybierajÄ…c opcjÄ™ <b>WyodrÄ™bnij wszystkie</b>.</p>
    <p style="margin: 0;">2.4. Teraz powinien otworzyÄ‡ siÄ™ rozpakowany folder z dwoma plikami Excel wewnÄ…trz - jak na obrazku poniÅ¼ej.</p>
</div>
""", unsafe_allow_html=True)  
st.markdown(""" """)
st.image("potrzebne_fotki/rozpakowany_zip.png")


st.markdown("""
3. PrzeciÄ…gnij plik RaportPromocyjny na szare pole poniÅ¼ej.  
4. Teraz trzeba chwilkÄ™ poczekaÄ‡... plik siÄ™ zaÅ‚aduje, a w prawym gÃ³rnym rogu pojawi siÄ™ ikonka ludzika oraz napis **RUNNING...** - to znaczy, Å¼e aplikacja myÅ›li, dajmy jej chwilÄ™ :)
5. Gdy wszystko przebiegnie zgodnie z planem i ludzik zakoÅ„czy bieg, pojawi siÄ™ przycisk **Pobierz porÃ³wnanie rabatÃ³w**.
""")












df = st.file_uploader(
    label = "WrzuÄ‡ plik RaportPromocyjny"
)
if df:
    df = pd.read_csv(df, sep=';')
    st.write(df.head())

# Wybieranie tylko okreÅ›lonych kolumn z DataFrame
kolumny = [
    'Id MateriaÅ‚u', 'Nazwa MateriaÅ‚u','Nr producenta sprzedaÅ¼owego', 'Nazwa producenta sprzedaÅ¼owego', 
    'identyfikator promocji', 'Nazwa Promocji', 'Nr zlecenia', 'Data obowiÄ…zywania promocji od','Data obowiÄ…zywania promocji do',  
    'SkÅ‚ad (SPR,SGL)', 'Czy dopuszcza rabat kontraktowy','Rodzaj warunku pÅ‚atnoÅ›ci',
    'Rabat Promocyjny'

]

#print("Typ df:", type(df))
# Filtruj kolumny w DataFrame
df = df[kolumny]
#df
# Czy dopuszcza rabat kontraktowy = 1 - tylko promocje WHA
df = df[df["Czy dopuszcza rabat kontraktowy"] == 1]
#df

# Rodzaj promocji
df["Rodzaj promocji"] = ""  # Inicjalizacja kolumny
df.loc[df["Nr zlecenia"] == 61114, "Rodzaj promocji"] = "ÅšZ/P"
df.loc[df["Nazwa Promocji"].str.contains("ZGZ", na=False), "Rodzaj promocji"] = "ZGZ"
df.loc[df["Nr zlecenia"] == 27001, "Rodzaj promocji"] = "centralne"
df.loc[df["Nazwa Promocji"].str.contains("BKS", na=False), "Rodzaj promocji"] = "sieci"
df.loc[df["Nazwa Promocji"].str.contains("RPM", na=False), "Rodzaj promocji"] = "RPM"
df.loc[df["Nazwa Promocji"].str.contains("IPRA", na=False), "Rodzaj promocji"] = "IPRA"
df.loc[df["Nazwa Promocji"].str.contains("RPM_HIT|RPM HIT", na=False, regex=True), "Rodzaj promocji"] = "EO"
#df

# Oczyszczanie kolumny 'Rabat Promocyjny'
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].fillna(0)
df = df[df["Rabat Promocyjny"] != 0]
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].str.replace(',', '.')  # ZastÄ…p przecinki kropkami, jeÅ›li sÄ…
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].str.strip()  # Usuwanie biaÅ‚ych znakÃ³w
# Konwersja na typ numeryczny (float), w przypadku problemÃ³w, zamienia wartoÅ›ci na NaN
df['Rabat Promocyjny'] = pd.to_numeric(df['Rabat Promocyjny'])
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].abs()
df['Rabat Promocyjny'] = df['Rabat Promocyjny'] / 100
# ZaokrÄ…glenie do 2 miejsc po przecinku (opcjonalnie)
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].round(4)
df = df[df["Rabat Promocyjny"] != 0]

#df

# Sprawdzenie wartoÅ›ci po konwersji
# st.write("Typ danych w kolumnie 'Rabat Promocyjny':", df['Rabat Promocyjny'].dtype)

# Sprawdzenie wartoÅ›ci po konwersji
# st.write("PrzykÅ‚adowe wartoÅ›ci w 'Rabat Promocyjny':", df['Rabat Promocyjny'].head())

df1 = df.copy()
# UsuniÄ™cie spacji i zamiana pustych stringÃ³w na NaN
df1 = df1.dropna(subset=["Rodzaj promocji"])
df1["Rabat Promocyjny"] = pd.to_numeric(df1["Rabat Promocyjny"], errors="coerce")


# widok z kolejnego arkusza
# Tworzenie tabeli przestawnej
pivot_table = df1.pivot_table(
    index=["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u"], 
    columns="Rodzaj promocji", 
    values="Rabat Promocyjny", 
    aggfunc="max"
)

#pivot_table
# Resetowanie indeksu dla lepszej czytelnoÅ›ci
pivot_table1 = pivot_table.reset_index()
# WybÃ³r tylko konkretnych kolumn (np. "Promocja A" i "Promocja B")
selected_columns = ["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u", "IPRA", "EO", "ÅšZ/P", "RPM", "ZGZ", "sieci", "centralne"]
#st.write("Kolumny w pivot_table1:", pivot_table1.columns.tolist())
#st.write("Wybrane kolumny:", selected_columns)
selected_columns = [col for col in selected_columns if col in pivot_table1.columns]
pivot_table1 = pivot_table1[selected_columns]

#pivot_table1


# Tylko IPRA, EO i ÅšZ/P
selected2 = ["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u", "IPRA", "EO", "ÅšZ/P"]
selected2 = [col for col in selected2 if col in pivot_table1.columns]
pivot_table2 = pivot_table1[selected2]
# Lista kolumn do sprawdzenia
kolumny_do_sprawdzenia = ["IPRA", "EO", "ÅšZ/P"]

# Filtruj tylko te, ktÃ³re faktycznie istniejÄ… w DataFrame
istniejace_kolumny = [col for col in kolumny_do_sprawdzenia if col in pivot_table2.columns]

# UsuÅ„ wiersze, gdzie wszystkie z tych kolumn majÄ… NaN
if istniejace_kolumny:
    pivot_table2 = pivot_table2.dropna(subset=istniejace_kolumny, how="all")
#pivot_table2 = pivot_table2.dropna(subset=["IPRA", "EO", "ÅšZ/P"], how="all")
#pivot_table2


# SÄ… w IPRA, nie ma w ÅšZ/P
# Krok 1: Wybieramy produkty, ktÃ³re sÄ… w "IPRA", ale nie ma ich w "ÅšZ/P"
df_ipra = pivot_table2[pivot_table2["IPRA"].notna()]  # Wybieramy tylko te wiersze, gdzie w kolumnie "IPRA" jest wartoÅ›Ä‡ (nie NaN)
df_szp = pivot_table2[pivot_table2["ÅšZ/P"].notna()]  # Wybieramy tylko te wiersze, gdzie w kolumnie "ÅšZ/P" jest wartoÅ›Ä‡ (nie NaN)
# Krok 2: Usuwamy produkty z df_ipra, ktÃ³re wystÄ™pujÄ… w df_szp
# ZakÅ‚adajÄ…c, Å¼e "Id MateriaÅ‚u" set difference na Id materiaÅ‚u
products_in_ipra_not_in_szp = df_ipra[~df_ipra["Id MateriaÅ‚u"].isin(df_szp["Id MateriaÅ‚u"])]
# Krok 3: Tworzymy tabelÄ™ z produktami, ktÃ³re sÄ… w IPRA, ale nie w ÅšZ/P
# MoÅ¼esz dodaÄ‡ dowolne kolumny, ktÃ³re chcesz w tej tabeli, np.:
products_ipra_not_szp = products_in_ipra_not_in_szp[["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u", "IPRA"]]


# SÄ… w EO, nie ma w ÅšZ/P
#df_eo = pivot_table2[pivot_table2["EO"].notna()]
#products_in_eo_not_in_szp = df_eo[~df_eo["Id MateriaÅ‚u"].isin(df_szp["Id MateriaÅ‚u"])]
#products_eo_not_szp = products_in_eo_not_in_szp[["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u", "EO"]]

# SÄ… w ÅšZ/P, nie ma w IPRA
products_in_szp_not_in_ipra = df_szp[~df_szp["Id MateriaÅ‚u"].isin(df_ipra["Id MateriaÅ‚u"])]
products_szp_not_ipra = products_in_szp_not_in_ipra[["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u", "ÅšZ/P"]]

# SÄ… w ÅšZ/P, nie ma w EO
#products_in_szp_not_in_eo = df_szp[~df_szp["Id MateriaÅ‚u"].isin(df_eo["Id MateriaÅ‚u"])]
#products_szp_not_eo = products_in_szp_not_in_eo[["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u", "ÅšZ/P"]]

# SÄ… w IPRA, nie ma w EO
#products_in_ipra_not_in_eo = df_ipra[~df_ipra["Id MateriaÅ‚u"].isin(df_eo["Id MateriaÅ‚u"])]
#products_ipra_not_eo = products_in_ipra_not_in_eo[["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u", "IPRA"]]

# SÄ… w EO, nie ma w IPRA
#products_in_eo_not_in_ipra = df_eo[~df_eo["Id MateriaÅ‚u"].isin(df_ipra["Id MateriaÅ‚u"])]
#products_eo_not_ipra = products_in_eo_not_in_ipra[["Nazwa producenta sprzedaÅ¼owego", "Id MateriaÅ‚u", "Nazwa MateriaÅ‚u", "EO"]]





# Pobranie dzisiejszej daty w formacie YYYY-MM-DD
today = datetime.datetime.today().strftime('%d-%m-%Y')

# Tworzenie pliku Excel w pamiÄ™ci
excel_file1 = io.BytesIO()

with pd.ExcelWriter(excel_file1, engine='xlsxwriter') as writer:
    # Zapisywanie arkuszy
    pivot_table1.to_excel(writer, index=False, sheet_name='porÃ³wnanie rabatÃ³w')
    pivot_table2.to_excel(writer, index=False, sheet_name='IPRA vs ÅšZP')
    products_ipra_not_szp.to_excel(writer, index=False, sheet_name='sÄ… w IPRA - nie w ÅšZP')
    #products_ipra_not_eo.to_excel(writer, index=False, sheet_name='sÄ… w IPRA - nie w EO')
    #products_eo_not_ipra.to_excel(writer, index=False, sheet_name='sÄ… w EO - nie w IPRA')
    #products_eo_not_szp.to_excel(writer, index=False, sheet_name='sÄ… w EO - nie w ÅšZP')
    products_szp_not_ipra.to_excel(writer, index=False, sheet_name='sÄ… w ÅšZP - nie w IPRA')
    #products_szp_not_eo.to_excel(writer, index=False, sheet_name='sÄ… w ÅšZP - nie w EO')
    df.to_excel(writer, index=False, sheet_name='dane')

    # Pobranie workbooka i arkuszy
    workbook = writer.book
    worksheet1 = writer.sheets["dane"]
    worksheet2 = writer.sheets["porÃ³wnanie rabatÃ³w"]
    worksheet3 = writer.sheets["IPRA vs ÅšZP"]
    worksheet4 = writer.sheets["sÄ… w IPRA - nie w ÅšZP"]
    #worksheet5 = writer.sheets["sÄ… w IPRA - nie w EO"]
    #worksheet6 = writer.sheets["sÄ… w EO - nie w IPRA"]
    #worksheet7 = writer.sheets["sÄ… w EO - nie w ÅšZP"]
    worksheet8 = writer.sheets["sÄ… w ÅšZP - nie w IPRA"]
    #worksheet9 = writer.sheets["sÄ… w ÅšZP - nie w EO"]

    # ğŸ¨ Ustawienie kolorÃ³w zakÅ‚adek
    worksheet1.set_tab_color('#0000FF')  # ğŸ”µ Niebieski dla "dane"
    worksheet2.set_tab_color('#008000')  # ğŸŸ¢ Zielony dla "porÃ³wnanie rabatÃ³w"
    worksheet3.set_tab_color('#008000')  # ğŸŸ¢ Zielony dla "IPRA vs ÅšZP"
    
    pomaranczowy = '#FFA500'  # ğŸŸ  PomaraÅ„czowy dla arkuszy "sÄ… w ... - nie w ..."
    worksheet4.set_tab_color(pomaranczowy)
    #worksheet5.set_tab_color(pomaranczowy)
    #worksheet6.set_tab_color(pomaranczowy)
    #worksheet7.set_tab_color(pomaranczowy)
    worksheet8.set_tab_color(pomaranczowy)
    #worksheet9.set_tab_color(pomaranczowy)

    # ğŸ¨ Definiowanie formatÃ³w kolorÃ³w dla rabatÃ³w
    green_format = workbook.add_format({'bg_color': '#C6EFCE', 'font_color': '#006100'})  # Zielony
    red_format = workbook.add_format({'bg_color': '#FFC7CE', 'font_color': '#9C0006'})  # Czerwony
    orange_format = workbook.add_format({'bg_color': '#FFA500', 'font_color': '#000000'})  # PomaraÅ„czowy

    # Pobranie rozmiaru tabeli
    num_rows = len(pivot_table2)
    rabat_range = f"D2:F{num_rows+1}"  # Kolumny D, E, F (IPRA, EO, ÅšZ/P)

    # Pobranie rozmiaru tabeli
    num_rows = len(pivot_table2)
    rabat_range = f"D2:F{num_rows+1}"  # Kolumny D, E, F (IPRA, EO, ÅšZ/P)

    # Pobranie rozmiaru tabeli
    num_rows = len(pivot_table2)
    rabat_range = f"D2:F{num_rows+1}"  # Zakres dla kolumn IPRA, EO, ÅšZ/P
    
    # Formatowanie: NajwyÅ¼szy rabat â†’ zielony
    for col in ['D', 'E', 'F']:
        worksheet3.conditional_format(f"{col}2:{col}{num_rows+1}", {
            'type': 'formula',
            'criteria': f"={col}2=MAX($D2:$F2)",
            'format': green_format
        })
    
    # Formatowanie: NajniÅ¼szy rabat â†’ czerwony
    for col in ['D', 'E', 'F']:
        worksheet3.conditional_format(f"{col}2:{col}{num_rows+1}", {
            'type': 'formula',
            'criteria': f"={col}2=MIN(IF($D2:$F2<>\"\", $D2:$F2))",
            'format': red_format
        })
    
    # Formatowanie: Brak rabatu â†’ pomaraÅ„czowy
    worksheet3.conditional_format(rabat_range, {
        'type': 'blanks',
        'format': orange_format
    })

    # ğŸ“ Ustawienie szerokoÅ›ci kolumn
    max_length = pivot_table1['Nazwa MateriaÅ‚u'].apply(lambda x: len(str(x))).max()
    max_length1 = pivot_table1['Nazwa producenta sprzedaÅ¼owego'].apply(lambda x: len(str(x))).max()
    
    #for ws in [worksheet2, worksheet3, worksheet4, worksheet5, worksheet6, worksheet7, worksheet8, worksheet9]:
    for ws in [worksheet2, worksheet3, worksheet4, worksheet8]:
        ws.set_column('C:C', max_length + 2)  # Kolumna C - Nazwa MateriaÅ‚u
        ws.set_column('A:A', max_length1 + 2)  # Kolumna A - Nazwa producenta sprzedaÅ¼owego

# Resetowanie wskaÅºnika do poczÄ…tku pliku
excel_file1.seek(0)

# Pobranie pliku w Streamlit
st.download_button(
    label='Pobierz porÃ³wnanie rabatÃ³w',
    data=excel_file1,
    file_name=f'PorÃ³wnanie_rabatÃ³w_{today}.xlsx',
    mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
)

# st.write(f"Zakres formatowania: {rabat_range}")
st.markdown("""
### ğŸ”¹ Legenda kolorÃ³w arkuszy:
- ğŸŸ¢ **Zielony** â€“ porÃ³wnanie rabatÃ³w w zaleÅ¼noÅ›ci od rodzaju promocji.
- ğŸŸ  **PomaraÅ„czowe** â€“ arkusze przedstawiajÄ…ce listÄ™ produktÃ³w, ktÃ³re w jednym programie sÄ… w promocji, a w innym nie.
- ğŸ”µ **Niebieski** â€“ najwaÅ¼niejsze dane z pliku RaportPromocyjny.


### ğŸ“‚ Opis arkuszy:
- **Arkusz 1 â€“ porÃ³wnanie rabatÃ³w**: Zestawione wartoÅ›ci rabatu w zaleÅ¼noÅ›ci od rodzaju promocji (IPRA, EO, ÅšZ/P, RPM, ZGZ, sieci, promocje centralne).
- **Arkusz 2 â€“ IPRA vs ÅšZP**: PorÃ³wnanie wysyokoÅ›ci rabatu dla IPRA, EO i Åšwiata Zdrowia/Partnera z zaznaczonymi kolorystycznie wysokoÅ›ciami rabatu (zielony - rabat najwyÅ¼szy, czerwony - rabat najniÅ¼szy, pomaraÅ„czowy - brak rabatu).
- **Arkusz 3 â€“ sÄ… w IPRA - nie w ÅšZP**: Zestawienie produktÃ³w, ktÃ³re aktualnie sÄ… w promocjach IPRA, nie ma w Åšwiecie Zdrowia/Partnerze.
- **Arkusz 4 â€“ sÄ… w IPRA - nie w EO**: Zestawienie produktÃ³w, ktÃ³re aktualnie sÄ… w promocjach IPRA, nie ma w EO.
- **Arkusz 5 â€“ sÄ… w EO - nie w IPRA**: Zestawienie produktÃ³w, ktÃ³re aktualnie sÄ… w promocjach EO, nie ma w IPRA.
- **Arkusz 6 â€“ sÄ… w EO - nie w ÅšZP**: Zestawienie produktÃ³w, ktÃ³re aktualnie sÄ… w promocjach EO, nie ma w Åšwiecie Zdrowia/Partnerze.
- **Arkusz 7 â€“ sÄ… w ÅšZP - nie w IPRA**: Zestawienie produktÃ³w, ktÃ³re aktualnie sÄ… w promocjach Åšwiata Zdrowia/Partnera, nie ma w IPRA.
- **Arkusz 8 â€“ sÄ… w ÅšZP - nie w EO**: Zestawienie produktÃ³w, ktÃ³re aktualnie sÄ… w promocjach Åšwiata Zdrowia/Partnera, nie ma w EO.
- **Arkusz 9 â€“ dane**: Zawiera listÄ™ aktualnych promocji z datami obowiÄ…zywania po produktach z wysokoÅ›ciÄ… rabatu.

""", unsafe_allow_html=True)

