# -*- coding: utf-8 -*-
"""Soczyste rabaty.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bfU5lwdNa2GOPWmQ9-URaf30VnlBzQC0
"""

#importowanie potrzebnych bibliotek
import os
import openpyxl
import streamlit as st
import pandas as pd
import numpy as np
import altair as alt
import plotly.express as px
import plotly.graph_objects as go
from urllib.request import urlopen
import json
import io
import datetime



st.set_page_config(page_title='Por贸wnanie rabat贸w - IPRA vs P+', layout='wide')



tabs_font_css = """
<style>
div[class*="stTextInput"] label {
  font-size: 26px;
  color: black;
}
div[class*="stSelectbox"] label {
  font-size: 26px;
  color: black;
}
</style>
"""



df = st.file_uploader(
    label = "Wrzu Raport promocyjny"
)
if df:
    df = pd.read_csv(df, sep=';')
    st.write(df.head())

# Wybieranie tylko okrelonych kolumn z DataFrame
kolumny = [
    'Id Materiau', 'Nazwa Materiau','Nr producenta sprzeda偶owego', 'Nazwa producenta sprzeda偶owego', 
    'identyfikator promocji', 'Nazwa Promocji', 'Nr zlecenia', 'Data obowizywania promocji od','Data obowizywania promocji do',  
    'Skad (SPR,SGL)', 'Czy dopuszcza rabat kontraktowy','Rodzaj warunku patnoci',
    'Rabat Promocyjny'

]

# Filtruj kolumny w DataFrame
df = df[kolumny]

# Czy dopuszcza rabat kontraktowy = 1 - tylko promocje WHA
df = df[df["Czy dopuszcza rabat kontraktowy"] == 1]


# Rodzaj promocji
df["Rodzaj promocji"] = ""  # Inicjalizacja kolumny
df.loc[df["Nr zlecenia"] == 61114, "Rodzaj promocji"] = "Z/P"
df.loc[df["Nazwa Promocji"].str.contains("ZGZ", na=False), "Rodzaj promocji"] = "ZGZ"
df.loc[df["Nazwa Promocji"].str.contains("BKS", na=False), "Rodzaj promocji"] = "sieci"
df.loc[df["Nr zlecenia"] == 27001, "Rodzaj promocji"] = "centralne"
df.loc[df["Nazwa Promocji"].str.contains("RPM", na=False), "Rodzaj promocji"] = "RPM"
df.loc[df["Nazwa Promocji"].str.contains("IPRA", na=False), "Rodzaj promocji"] = "IPRA"
df.loc[df["Nazwa Promocji"].str.contains("RPM_HIT|RPM HIT", na=False, regex=True), "Rodzaj promocji"] = "EO"

# Oczyszczanie kolumny 'Rabat Promocyjny'
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].fillna(0)
df = df[df["Rabat Promocyjny"] != 0]
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].str.replace(',', '.')  # Zastp przecinki kropkami, jeli s
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].str.strip()  # Usuwanie biaych znak贸w
# Konwersja na typ numeryczny (float), w przypadku problem贸w, zamienia wartoci na NaN
df['Rabat Promocyjny'] = pd.to_numeric(df['Rabat Promocyjny'])
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].abs()
df['Rabat Promocyjny'] = df['Rabat Promocyjny'] / 100
# Zaokrglenie do 2 miejsc po przecinku (opcjonalnie)
df['Rabat Promocyjny'] = df['Rabat Promocyjny'].round(4)
df = df[df["Rabat Promocyjny"] != 0]



# Sprawdzenie wartoci po konwersji
st.write("Typ danych w kolumnie 'Rabat Promocyjny':", df['Rabat Promocyjny'].dtype)

# Sprawdzenie wartoci po konwersji
st.write("Przykadowe wartoci w 'Rabat Promocyjny':", df['Rabat Promocyjny'].head())

df1 = df.copy()
# Usunicie spacji i zamiana pustych string贸w na NaN
df1 = df1.dropna(subset=["Rodzaj promocji"])
df1["Rabat Promocyjny"] = pd.to_numeric(df1["Rabat Promocyjny"], errors="coerce")


# widok z kolejnego arkusza
# Tworzenie tabeli przestawnej
pivot_table = df1.pivot_table(
    index=["Nazwa producenta sprzeda偶owego", "Id Materiau", "Nazwa Materiau"], 
    columns="Rodzaj promocji", 
    values="Rabat Promocyjny", 
    aggfunc="max"
)

# Resetowanie indeksu dla lepszej czytelnoci
pivot_table1 = pivot_table.reset_index()
# Wyb贸r tylko konkretnych kolumn (np. "Promocja A" i "Promocja B")
selected_columns = ["Nazwa producenta sprzeda偶owego", "Id Materiau", "Nazwa Materiau", "IPRA", "EO", "Z/P", "RPM", "ZGZ", "sieci", "centralne"]
pivot_table1 = pivot_table1[selected_columns]

pivot_table1


# Tylko IPRA, EO i Z/P
selected2 = ["Nazwa producenta sprzeda偶owego", "Id Materiau", "Nazwa Materiau", "IPRA", "EO", "Z/P"]
pivot_table2 = pivot_table1[selected2]
pivot_table2 = pivot_table2.dropna(subset=["IPRA", "EO", "Z/P"], how="all")



# S w IPRA, nie ma w Z/P
# Krok 1: Wybieramy produkty, kt贸re s w "IPRA", ale nie ma ich w "Z/P"
df_ipra = pivot_table2[pivot_table2["IPRA"].notna()]  # Wybieramy tylko te wiersze, gdzie w kolumnie "IPRA" jest warto (nie NaN)
df_szp = pivot_table2[pivot_table2["Z/P"].notna()]  # Wybieramy tylko te wiersze, gdzie w kolumnie "Z/P" jest warto (nie NaN)
# Krok 2: Usuwamy produkty z df_ipra, kt贸re wystpuj w df_szp
# Zakadajc, 偶e "Id Materiau" set difference na Id materiau
products_in_ipra_not_in_szp = df_ipra[~df_ipra["Id Materiau"].isin(df_szp["Id Materiau"])]
# Krok 3: Tworzymy tabel z produktami, kt贸re s w IPRA, ale nie w Z/P
# Mo偶esz doda dowolne kolumny, kt贸re chcesz w tej tabeli, np.:
products_ipra_not_szp = products_in_ipra_not_in_szp[["Nazwa producenta sprzeda偶owego", "Id Materiau", "Nazwa Materiau", "IPRA"]]


# S w EO, nie ma w Z/P
df_eo = pivot_table2[pivot_table2["EO"].notna()]
products_in_eo_not_in_szp = df_eo[~df_eo["Id Materiau"].isin(df_szp["Id Materiau"])]
products_eo_not_szp = products_in_eo_not_in_szp[["Nazwa producenta sprzeda偶owego", "Id Materiau", "Nazwa Materiau", "EO"]]

# S w Z/P, nie ma w IPRA
products_in_szp_not_in_ipra = df_szp[~df_szp["Id Materiau"].isin(df_ipra["Id Materiau"])]
products_szp_not_ipra = products_in_szp_not_in_ipra[["Nazwa producenta sprzeda偶owego", "Id Materiau", "Nazwa Materiau", "Z/P"]]

# S w Z/P, nie ma w EO
products_in_szp_not_in_eo = df_szp[~df_szp["Id Materiau"].isin(df_eo["Id Materiau"])]
products_szp_not_eo = products_in_szp_not_in_eo[["Nazwa producenta sprzeda偶owego", "Id Materiau", "Nazwa Materiau", "Z/P"]]




# Pobranie dzisiejszej daty w formacie YYYY-MM-DD
today = datetime.datetime.today().strftime('%d-%m-%Y')


# Tworzenie pliku Excel w pamici
excel_file1 = io.BytesIO()

with pd.ExcelWriter(excel_file1, engine='xlsxwriter') as writer:
    # Zapisanie oryginalnych danych do arkusza "dane"
    df.to_excel(writer, index=False, sheet_name='dane')

    # Zapisanie tabeli przestawnej do arkusza "por贸wnanie rabat贸w"
    pivot_table1.to_excel(writer, index=False, sheet_name='por贸wnanie rabat贸w')

    # Zapisanie tabeli przestawnej do arkusza "IPRA vs ZP"
    pivot_table2.to_excel(writer, index=False, sheet_name='IPRA vs ZP')

    # Zapisanie tabeli przestawnej do arkuszy "s w ... - nie w ..."
    products_ipra_not_szp.to_excel(writer, index=False, sheet_name='s w IPRA - nie w ZP')
    products_eo_not_szp.to_excel(writer, index=False, sheet_name='s w EO - nie w ZP')
    products_szp_not_ipra.to_excel(writer, index=False, sheet_name='s w ZP - nie w IPRA')
    products_szp_not_eo.to_excel(writer, index=False, sheet_name='s w ZP - nie w EO')

    # Pobranie workbooka i arkuszy
    workbook = writer.book
    worksheet1 = writer.sheets["dane"]
    worksheet2 = writer.sheets["por贸wnanie rabat贸w"]
    worksheet3 = writer.sheets["IPRA vs ZP"]
    worksheet4 = writer.sheets["s w IPRA - nie w ZP"]
    worksheet5 = writer.sheets["s w EO - nie w ZP"]
    worksheet6 = writer.sheets["s w ZP - nie w IPRA"]
    worksheet7 = writer.sheets["s w ZP - nie w EO"]

    # Ustawienie kolor贸w zakadek
    worksheet1.set_tab_color('#0000FF')  #  Niebieski dla "dane"
    worksheet2.set_tab_color('#008000')  #  Zielony dla "por贸wnanie rabat贸w"
    worksheet3.set_tab_color('#008000')  #  Zielony dla "IPRA vs ZP"
    
    #  Pomaraczowy dla arkuszy "s w ... - nie w ..."
    pomaranczowy = '#FFA500'
    worksheet4.set_tab_color(pomaranczowy)
    worksheet5.set_tab_color(pomaranczowy)
    worksheet6.set_tab_color(pomaranczowy)
    worksheet7.set_tab_color(pomaranczowy)

    # Ustaw szeroko kolumny 'Nazwa Materiau' do dugoci tekstu
    max_length = pivot_table1['Nazwa Materiau'].apply(lambda x: len(str(x))).max()
    max_length1 = pivot_table1['Nazwa producenta sprzeda偶owego'].apply(lambda x: len(str(x))).max()
    
    # Ustawienie szerokoci kolumn w odpowiednich arkuszach
    for ws in [worksheet2, worksheet3, worksheet4, worksheet5, worksheet6, worksheet7]:
        ws.set_column('C:C', max_length + 2)  # Kolumna C - Nazwa Materiau
        ws.set_column('A:A', max_length1 + 2)  # Kolumna A - Nazwa producenta sprzeda偶owego

# Resetowanie wska藕nika do pocztku pliku
excel_file1.seek(0)

# Umo偶liwienie pobrania pliku Excel w Streamlit
st.download_button(
    label='Pobierz por贸wnanie rabat贸w',
    data=excel_file1,
    file_name=f'Por贸wnanie_rabat贸w_{today}.xlsx',
    mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
)

